<link href='/scripts/fullcalendar/main.css' rel='stylesheet' />
<script src='/scripts/fullcalendar/main.js'></script>

<script src='/scripts/fullcalendar/locales/ru.js'></script>
<script src='/scripts/fullcalendar/locales/by.js'></script>


<h4 class="text-center my-3">{{__ 'calendar.title'}}</h4>
<div class="container calendar-container mb-5">

    <div id='calendar'></div>
</div>


<script>
    let localePosInCookie = document.cookie.indexOf('locale=') + 7;
    var pageLocale = document.cookie.slice(localePosInCookie, localePosInCookie + 2);
    var calendar;
    document.addEventListener('DOMContentLoaded', async function () {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {

            locale: pageLocale,
            views: {
                dayGridMonth: { 
                    fixedWeekCount:false                
                }
            },
            height: 'auto',
            initialView: 'dayGridMonth',
            defaultView: 'dayGridMonth',
         
            eventColor: 'orange',
            headerToolbar: {
                left: 'prev,today,next',
                right: 'title'
            },

            eventMouseEnter: function (info) {
                var id = info.event.id;
                var link = "/events#" + id;
            },
            eventMouseLeave: function (info) {
            },
            eventTimeFormat: { // like '14:30:00'
                hour: '2-digit',
                minute: '2-digit',
                meridiem: true
            }

        });
        await initCalend();
        document.querySelectorAll('.fc-button').forEach((element)=>{
            element.addEventListener('click', ()=>{
                setPosters();
            })
        });
        setPosters();


    });

    function DateToISOLocal(date) {
        // JS interprets db date as local and converts to UTC
        var localDate = date - date.getTimezoneOffset() * 60 * 1000;
        return new Date(localDate).toISOString().slice(0, 19);
    }

    function setPosters(){
        document.querySelectorAll(".fc-event-title").forEach((idEl)=>{
            var id = idEl.innerHTML;
            var cell=idEl.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode;
            var frame = cell.querySelector(".fc-daygrid-day-frame");
            //var number=frame.querySelector('.fc-daygrid-day-top');
            cell.style.backgroundImage=`url("/img/posters/${id}.jpg")`;
            //number.style.backgroundColor="rgba(255,255,255,0.5)"
            cell.style.cursor="pointer";
            frame.style.backgroundColor="rgb(255,255,255)"
            frame.style.opacity="0.5";
            cell.addEventListener('click',()=>{
                window.location = "/events#"+id;

            })
        });
    }
    async function initCalend() {
        response = await fetch('/api/concerts');
        if (response.ok) {
            var concerts = await response.json();
        } else {
            alert("Ошибка HTTP: " + response.status);
        }
        concerts.forEach((concert) => {
            console.log(concert);
            concertDate = new Date(concert.date);
            concertDate -= concertDate.getTimezoneOffset() * 60 * 1000;

            let concertUrl = ((concertDate >= Date.now()) ? ("/events#") : ("/events/archive#")) + concert.id;
            calendar.addEvent({
                title: concert.id,
                id: concert.id,
                start: concert.date,
                url: concertUrl,
                display:'block',
                backgroundColor :'#AE5C39',
                textColor: 'white',
                borderColor:'#C9947D'
            });
        })
        calendar.render();
    }











</script>